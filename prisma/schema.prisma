generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  name                  String
  passwordHash          String
  role                  UserRole               @default(CASHIER)
  status                UserStatus             @default(ACTIVE)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  baseSalary            Decimal?               @db.Decimal(10, 2)
  phone                 String?
  auditLogs             AuditLog[]
  deliveries            DeliveryInfo[]
  expenses              Expense[]
  financialTransactions FinancialTransaction[]
  inventorySessions     InventorySession[]
  investments           Investment[]
  kitchenOrders         KitchenOrder[]
  payrolls              Payroll[]
  salaryAdvances        SalaryAdvance[]
  sales                 Sale[]
  sessions              Session[]
  stockMovements        StockMovement[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model SalaryAdvance {
  id        String        @id @default(cuid())
  userId    String
  amount    Decimal       @db.Decimal(10, 2)
  date      DateTime      @default(now())
  reason    String?
  status    AdvanceStatus @default(PENDING)
  expenseId String?       @unique
  payrollId String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  expense   Expense?      @relation(fields: [expenseId], references: [id])
  payroll   Payroll?      @relation(fields: [payrollId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([date])
  @@map("salary_advances")
}

model Payroll {
  id            String          @id @default(cuid())
  userId        String
  month         Int
  year          Int
  baseAmount    Decimal         @db.Decimal(10, 2)
  advancesTotal Decimal         @default(0) @db.Decimal(10, 2)
  bonus         Decimal         @default(0) @db.Decimal(10, 2)
  penalty       Decimal         @default(0) @db.Decimal(10, 2)
  netPaid       Decimal         @db.Decimal(10, 2)
  paymentDate   DateTime        @default(now())
  status        String          @default("COMPLETED")
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  user          User            @relation(fields: [userId], references: [id])
  advances      SalaryAdvance[]

  @@unique([userId, month, year])
  @@map("payrolls")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String?
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model ExchangeRate {
  id            String   @id @default(cuid())
  rateUsdToCdf  Decimal  @db.Decimal(10, 2)
  effectiveDate DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  active        Boolean  @default(true)

  @@index([effectiveDate])
  @@index([active])
  @@map("exchange_rates")
}

model SaleSpace {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  prices      ProductPrice[]

  @@map("sale_spaces")
}

model Product {
  id               String            @id @default(cuid())
  name             String
  type             ProductType
  beverageCategory BeverageCategory?
  foodCategory     FoodCategory?
  size             ProductSize       @default(STANDARD)
  saleUnit         SaleUnit
  unitValue        Decimal?          @db.Decimal(10, 2)
  vendable         Boolean           @default(true)
  active           Boolean           @default(true)
  imageUrl         String?
  description      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  packingQuantity  Int?              @default(1)
  purchaseUnit     String?
  inventoryItems   InventoryItem[]
  costs            ProductCost[]
  prices           ProductPrice[]
  saleItems        SaleItem[]
  stockItems       StockItem[]
  stockMovements   StockMovement[]

  @@index([type])
  @@index([beverageCategory])
  @@index([foodCategory])
  @@index([size])
  @@index([active])
  @@index([vendable])
  @@index([active, vendable])
  @@map("products")
}

model ProductPrice {
  id        String    @id @default(cuid())
  productId String
  spaceId   String
  priceUsd  Decimal   @db.Decimal(10, 2)
  priceCdf  Decimal   @db.Decimal(10, 2)
  forUnit   SaleUnit  @default(BOTTLE)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  space     SaleSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([productId, spaceId, forUnit])
  @@index([productId])
  @@index([spaceId])
  @@map("product_prices")
}

model ProductCost {
  id          String   @id @default(cuid())
  productId   String
  unitCostUsd Decimal  @db.Decimal(10, 2)
  unitCostCdf Decimal  @db.Decimal(10, 2)
  forUnit     SaleUnit @default(BOTTLE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, forUnit])
  @@map("product_costs")
}

model ProductTypeMetadata {
  id          String   @id @default(cuid())
  code        String   @unique
  label       String
  labelEn     String?
  description String?
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active])
  @@index([sortOrder])
  @@map("product_type_metadata")
}

model CategoryMetadata {
  id          String   @id @default(cuid())
  code        String   @unique
  productType String
  label       String
  labelEn     String?
  description String?
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productType])
  @@index([active])
  @@index([sortOrder])
  @@map("category_metadata")
}

model ExpenseCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expenses    Expense[]

  @@map("expense_categories")
}

model StockItem {
  id        String        @id @default(cuid())
  productId String
  location  StockLocation
  quantity  Decimal       @db.Decimal(10, 2)
  updatedAt DateTime      @updatedAt
  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, location])
  @@map("stock_items")
}

model StockMovement {
  id           String            @id @default(cuid())
  productId    String
  type         StockMovementType
  quantity     Decimal           @db.Decimal(10, 2)
  fromLocation StockLocation?
  toLocation   StockLocation?
  reason       String?
  costValue    Decimal?          @db.Decimal(10, 2)
  userId       String?
  createdAt    DateTime          @default(now())
  investmentId String?
  investment   Investment?       @relation(fields: [investmentId], references: [id])
  product      Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user         User?             @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model Investment {
  id                String          @id @default(cuid())
  date              DateTime        @default(now())
  source            FundSource      @default(OWNER_CAPITAL)
  totalAmount       Decimal         @db.Decimal(12, 2)
  vendableAmount    Decimal         @db.Decimal(12, 2)
  nonVendableAmount Decimal         @db.Decimal(12, 2)
  expectedRevenue   Decimal         @db.Decimal(12, 2)
  expectedProfit    Decimal         @db.Decimal(12, 2)
  expectedRevenueVip Decimal?        @db.Decimal(12, 2)
  expectedProfitVip  Decimal?        @db.Decimal(12, 2)
  description       String?
  userId            String
  createdAt         DateTime        @default(now())
  exchangeRate      Decimal?        @db.Decimal(10, 2)
  totalAmountCdf    Decimal?        @db.Decimal(15, 2)
  
  // CDF Source of Truth Fields
  vendableAmountCdf Decimal?        @db.Decimal(15, 2)
  nonVendableAmountCdf Decimal?     @db.Decimal(15, 2)
  expectedRevenueCdf Decimal?       @db.Decimal(15, 2)
  expectedProfitCdf  Decimal?       @db.Decimal(15, 2)
  expectedRevenueVipCdf Decimal?    @db.Decimal(15, 2)
  expectedProfitVipCdf  Decimal?    @db.Decimal(15, 2)
  transportFeeCdf   Decimal?        @db.Decimal(15, 2)
  transportFee      Decimal?        @db.Decimal(10, 2)
  user              User            @relation(fields: [userId], references: [id])
  movements         StockMovement[]

  @@index([date])
  @@index([source])
  @@map("investments")
}

model Expense {
  id            String          @id @default(cuid())
  date          DateTime        @default(now())
  description   String
  amount        Decimal         @db.Decimal(10, 2)
  source        FundSource      @default(CASH_REGISTER)
  userId        String
  createdAt     DateTime        @default(now())
  categoryId    String
  updatedAt     DateTime        @updatedAt
  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  user          User            @relation(fields: [userId], references: [id])
  salaryAdvance SalaryAdvance?

  @@index([date])
  @@index([categoryId])
  @@map("expenses")
}

model InventorySession {
  id            String          @id @default(cuid())
  date          DateTime        @default(now())
  status        String          @default("OPEN")
  totalVariance Decimal?        @db.Decimal(10, 2)
  userId        String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  items         InventoryItem[]
  user          User            @relation(fields: [userId], references: [id])

  @@map("inventory_sessions")
}

model InventoryItem {
  id               String           @id @default(cuid())
  sessionId        String
  productId        String
  location         StockLocation
  expectedQuantity Decimal          @db.Decimal(10, 2)
  actualQuantity   Decimal          @db.Decimal(10, 2)
  variance         Decimal          @db.Decimal(10, 2)
  product          Product          @relation(fields: [productId], references: [id])
  session          InventorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("inventory_items")
}

model Client {
  id             String               @id @default(cuid())
  name           String
  phone          String?              @unique
  email          String?
  points         Int                  @default(0)
  notes          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  loyaltyHistory LoyaltyTransaction[]
  sales          Sale[]

  @@map("clients")
}

model LoyaltyTransaction {
  id        String   @id @default(cuid())
  clientId  String
  amount    Int
  reason    String?
  saleId    String?
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sale      Sale?    @relation(fields: [saleId], references: [id])

  @@index([clientId])
  @@map("loyalty_transactions")
}

model Sale {
  id            String                 @id @default(cuid())
  ticketNum     String                 @unique
  clientId      String?
  userId        String
  status        SaleStatus             @default(COMPLETED)
  paymentMethod PaymentMethod          @default(CASH)
  totalBrut     Decimal                @db.Decimal(10, 2)
  discount      Decimal                @default(0) @db.Decimal(10, 2)
  totalNet      Decimal                @db.Decimal(10, 2)
  pointsEarned  Int                    @default(0)
  pointsUsed    Int                    @default(0)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  discountBy    String?
  discountType  String?
  discountValue Decimal?               @db.Decimal(10, 2)
  orderType     OrderType              @default(DINE_IN)
  totalCdf      Decimal                @default(0) @db.Decimal(15, 2)
  deliveryInfo  DeliveryInfo?
  transactions  FinancialTransaction[]
  kitchenOrders KitchenOrder[]
  loyaltyTx     LoyaltyTransaction[]
  items         SaleItem[]
  client        Client?                @relation(fields: [clientId], references: [id])
  user          User                   @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([clientId])
  @@index([userId])
  @@index([status])
  @@index([orderType])
  @@map("sales")
}

model SaleItem {
  id           String  @id @default(cuid())
  saleId       String
  productId    String
  quantity     Decimal @db.Decimal(10, 2)
  unitPrice    Decimal @db.Decimal(10, 2)
  totalPrice   Decimal @db.Decimal(10, 2)
  unitCost     Decimal @default(0) @db.Decimal(10, 2)
  unitPriceCdf Decimal @default(0) @db.Decimal(15, 2)
  product      Product @relation(fields: [productId], references: [id])
  sale         Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model KitchenOrder {
  id          String      @id @default(cuid())
  saleId      String
  orderType   OrderType   @default(DINE_IN)
  status      OrderStatus @default(PENDING)
  priority    Int         @default(0)
  preparedBy  String?
  preparedAt  DateTime?
  deliveredAt DateTime?
  notes       String?
  createdAt   DateTime    @default(now())
  preparer    User?       @relation(fields: [preparedBy], references: [id])
  sale        Sale        @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([orderType])
  @@index([createdAt])
  @@index([saleId])
  @@map("kitchen_orders")
}

model DeliveryInfo {
  id             String         @id @default(cuid())
  saleId         String         @unique
  address        String
  phone          String
  instructions   String?
  estimatedTime  DateTime?
  deliveryStatus DeliveryStatus @default(PENDING)
  deliveredBy    String?
  deliveredAt    DateTime?
  createdAt      DateTime       @default(now())
  deliverer      User?          @relation(fields: [deliveredBy], references: [id])
  sale           Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([deliveryStatus])
  @@index([saleId])
  @@map("delivery_info")
}

model FinancialTransaction {
  id            String        @id @default(cuid())
  saleId        String
  amount        Decimal       @db.Decimal(10, 2)
  amountCdf     Decimal?      @db.Decimal(15, 2)
  paymentMethod PaymentMethod
  reference     String?
  userId        String
  createdAt     DateTime      @default(now())
  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id])

  @@index([saleId])
  @@index([userId])
  @@index([paymentMethod])
  @@index([createdAt])
  @@map("financial_transactions")
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  KITCHEN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AdvanceStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
  DEDUCTED
}

enum ProductType {
  BEVERAGE
  FOOD
  NON_VENDABLE
}

enum BeverageCategory {
  BIERE
  SUCRE
  EAU
  VIN
  WHISKY
  JUS
  ENERGIE
}

enum FoodCategory {
  GRILLADE
  FAST_FOOD
  ACCOMPAGNEMENT
  DESSERT
  PLAT_PRINCIPAL
}

enum ProductSize {
  SMALL
  LARGE
  STANDARD
}

enum SaleUnit {
  BOTTLE
  PLATE
  HALF_PLATE
  MEASURE
  PIECE
}

enum Currency {
  CDF
  USD
}

enum StockLocation {
  DEPOT
  FRIGO
  CASIER
  ECONOMAT
  CUISINE
}

enum StockMovementType {
  IN
  OUT
  TRANSFER
  LOSS
  ADJUSTMENT
}

enum FundSource {
  OWNER_CAPITAL
  CASH_REGISTER
}

enum PaymentMethod {
  CASH
  CARD
  MOBILE_MONEY
  LOYALTY_POINTS
  SPLIT
  OTHER
  AIRTEL_MONEY
  ORANGE_MONEY
  AFRIMONEY
  MPESA
}

enum SaleStatus {
  COMPLETED
  CANCELLED
  DRAFT
  PENDING_PAYMENT
}

enum OrderType {
  DINE_IN
  DELIVERY
  TAKEAWAY
}

enum OrderStatus {
  PENDING
  IN_PREPARATION
  READY
  DELIVERED
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  DELIVERED
  FAILED
}
